import Head from 'next/head';
import { useEffect, useState, useContext, useRef } from 'react';
import { MyContext } from '../../src/pages/_app';
import Slider from '../components/Slider';

// Import Swiper styles
import 'swiper/css';
import 'swiper/css/grid';
import 'swiper/css/pagination';

const calculateDistance = (
  lat1: number,
  lon1: number,
  lat2: number,
  lon2: number
) => {
  const R = 6371e3; // metres
  const φ1 = (lat1 * Math.PI) / 180; // φ, λ in radians
  const φ2 = (lat2 * Math.PI) / 180;
  const Δφ = ((lat2 - lat1) * Math.PI) / 180;
  const Δλ = ((lon2 - lon1) * Math.PI) / 180;

  const a =
    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
    Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  const d = (R * c) / 1000; // in km
  return d;
};

export default function Home({ churches }: any) {
  const [filteredChurches, setFilteredChurches] = useState<any>(churches);
  const [activeInput, setActiveInput] = useState(false);
  const searchInputRef = useRef(null);
  const [filter, setFilter] = useState<string>('');
  const [switchValue, setSwitchValue] = useState<boolean>(false);
  const { currentPosition } = useContext(MyContext);

  const handleTopLevelFilter = (e: any) => {
    const value = e.target.value;

    setFilter(value);
    setSwitchValue(false);
  };

  const handleDistanceFilter = (valueString: any) => {
    const value = parseInt(valueString);
    const filtered = churches.filter((church: any) => {
      const [churchALatitude, churchALongitude] = church.Location.replaceAll(
        ' ',
        ''
      ).split(',');

      const distance = calculateDistance(
        currentPosition.lat,
        currentPosition.lng,
        churchALatitude,
        churchALongitude
      );
      return distance <= value;
    });
    setFilteredChurches(filtered);
  };

  const handleInputChange = (value: string) => {
    if (!value) {
      setFilteredChurches(churches);
      setActiveInput(false);
      return;
    }

    const filterChurches = churches.filter((church: any) => {
      const churchName = church.Name.toLowerCase();
      return churchName.includes(value);
    });

    setActiveInput(true);
    setFilteredChurches(filterChurches);
  };

  useEffect(() => {
    let newChurches = [];
    if (filter && filter === "distance") {
      // distance was just toggled, search the first item of the distances which is 2km
      handleDistanceFilter("2")
    }
    else if (filter && filter !== 'distance') {
      // check the filter
      newChurches = churches.filter((church: any) => {
        const value = church[filter] === switchValue ? true : false;
        return value;
      });

      setFilteredChurches(newChurches);
    }
    else if (!filter) {
      // Reset the list will all Churches
      setFilteredChurches(churches)
    }
  }, [switchValue, filter, churches]);

  const churchesToDisplay = filter !== 'all' ? filteredChurches : churches;
  console.log("🚀 ~ Home ~ churchesToDisplay:", churchesToDisplay)

  return (
    <>
      <Head>
        <title>Localizador de Iglesias</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='icon' href='/favicon.ico' />
      </Head>

      <main className='max-w-7xl mx-auto p-5 w-full'>
        <div className='title-container' style={{ maxWidth: '1200px', margin: 'auto' }}>
          <h1 className='text-2xl mb-8'>Localizador de Iglesias</h1>

          <div className='search-input'>
            <select
              name='range'
              id='range'
              className='bg-transparent text-black p-2 text-base border border-gray-300 rounded-md w-40'
              onChange={handleTopLevelFilter}
              value={filter}
            >
              <option value=''>Nombre</option>
              <option value='Baptism'>Bautismo</option>
              <option value='Wedding'>Casamiento</option>
              <option value='FirstCommunion'>Primera Comunion</option>
              <option value='distance'>Distancia</option>
            </select>

            {filter === 'distance' ? (
              <select
                name='range'
                id='range'
                className='bg-transparent text-black p-2 text-base border border-gray-300 rounded-md w-40'
                onChange={(e) => handleDistanceFilter(e.target?.value)}
              >
                <option value='' disabled>
                  Elige un rango
                </option>
                <option value='2'>2km</option>
                <option value='5'>5km</option>
                <option value='10'>10km</option>
                <option value='20'>20km</option>
              </select>
            ) : null}

            {filter && filter !== 'distance' ? (
              <label
                className={`toggle-button ${switchValue ? 'active' : ''}`}
                id='toggleButton'
              >
                <div
                  onClick={() => setSwitchValue(!switchValue)}
                  className={`toggle-switch ${switchValue ? 'active' : ''}`}
                ></div>
              </label>
            ) : null}

            {!filter ? (
              <input
                placeholder='Busca una iglesia'
                onChange={(e) => handleInputChange(e.target.value)}
                ref={searchInputRef}
              />
            ) : null}

            {activeInput ? (
              <button
                onClick={() => {
                  setFilteredChurches(churches);
                  setActiveInput(false);
                  // @ts-ignore
                  searchInputRef.current.value = '';
                }}
              >
                X
              </button>
            ) : null}
          </div>
        </div>
        {churchesToDisplay.length > 0 ? <Slider content={churchesToDisplay} /> : null}
        {churchesToDisplay.length === 0 ? (
          <div style={{ maxWidth: '1200px', margin: 'auto', marginTop: '2rem' }}>
            <h2
              style={{
                color: 'white',
                fontSize: '1.2rem',
              }}
            >
              No hay Iglesias para mostrar
            </h2>
          </div>

        ) : null}
      </main>
    </>
  );
}

export async function getStaticProps() {
  const res = await fetch(
    `https://api-church-localizer.onrender.com/api/churches`
  );
  const churches = await res.json();

  return {
    props: {
      churches,
    },
  };
}
